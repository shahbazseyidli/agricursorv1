// Agri-Food Price Intelligence Platform
// Database Schema - SQLite for prototyping
// Version 2.0 - Added FPMA, GlobalCategory, Varieties

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  role          String    @default("USER") // ADMIN or USER
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================
// GLOBAL GEOGRAPHY - Universal country system
// ============================================

model GlobalCountry {
  id          String   @id @default(cuid())
  iso2        String   @unique // ISO 3166-1 alpha-2: AZ, US, DE
  iso3        String   @unique // ISO 3166-1 alpha-3: AZE, USA, DEU
  numericCode String?  @map("numeric_code") // ISO 3166-1 numeric: 031, 840, 276
  
  // Names
  nameEn      String   @map("name_en") // English name
  nameAz      String?  @map("name_az") // Azerbaijani name
  nameRu      String?  @map("name_ru") // Russian name
  
  // UN M49 Regions
  region      String   // Asia, Europe, Africa, Americas, Oceania
  subRegion   String?  @map("sub_region") // Western Asia, Eastern Europe, etc.
  
  // Visual
  flagEmoji   String?  @map("flag_emoji") // ðŸ‡¦ðŸ‡¿
  flagUrl     String?  @map("flag_url") // Custom flag image URL
  
  // Status
  isActive    Boolean  @default(true) @map("is_active")
  isFeatured  Boolean  @default(false) @map("is_featured") // Featured countries (AZ)
  sortOrder   Int      @default(0) @map("sort_order")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations to source-specific country tables
  azCountries    Country[]     // AZ data source countries
  euCountries    EuCountry[]   // Eurostat countries
  faoCountries   FaoCountry[]  // FAOSTAT countries
  fpmaCountries  FpmaCountry[] // FAO FPMA countries

  @@index([region])
  @@index([subRegion])
  @@map("global_countries")
}

// ============================================
// LOCAL GEOGRAPHY - AZ Data Source
// ============================================

model Country {
  id              String   @id @default(cuid())
  iso2            String   @unique
  name            String
  nameEn          String?  @map("name_en")
  nameRu          String?  @map("name_ru")
  globalCountryId String?  @map("global_country_id") // Link to GlobalCountry
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  globalCountry GlobalCountry? @relation(fields: [globalCountryId], references: [id])
  marketTypes   MarketType[]
  markets       Market[]
  categories    Category[]
  products      Product[]
  prices        Price[]
  aggregates    AzPriceAggregate[]

  @@index([globalCountryId])
  @@map("countries")
}

// ============================================
// GLOBAL CATEGORIES - Universal category system
// ============================================

model GlobalCategory {
  id            String   @id @default(cuid())
  code          String   @unique // HS2 code: "07", "08", "10"
  slug          String   @unique // vegetables, fruits, cereals
  nameEn        String   @map("name_en")
  nameAz        String?  @map("name_az")
  nameRu        String?  @map("name_ru")
  description   String?
  descriptionAz String?  @map("description_az")
  icon          String? // emoji or icon name
  image         String? // Image URL (manual upload or link)
  sortOrder     Int      @default(0) @map("sort_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  globalProducts  GlobalProduct[]
  localCategories Category[] // Local AZ categories linked to this global

  @@map("global_categories")
}

// ============================================
// MARKET STRUCTURE
// ============================================

model MarketType {
  id        String   @id @default(cuid())
  code      String   @unique // WHOLESALE, PROCESSING, RETAIL, FIELD
  nameAz    String   @map("name_az")
  nameEn    String?  @map("name_en")
  nameRu    String?  @map("name_ru")
  countryId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  country    Country            @relation(fields: [countryId], references: [id])
  markets    Market[]
  aggregates AzPriceAggregate[]

  @@unique([countryId, code])
  @@map("market_types")
}

model Market {
  id           String   @id @default(cuid())
  name         String
  nameEn       String?  @map("name_en")
  nameRu       String?  @map("name_ru")
  aliases      String? // Comma-separated aliases for Excel import mapping
  countryId    String
  marketTypeId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  country    Country    @relation(fields: [countryId], references: [id])
  marketType MarketType @relation(fields: [marketTypeId], references: [id])
  prices     Price[]

  @@unique([countryId, marketTypeId, name])
  @@index([countryId])
  @@index([marketTypeId])
  @@map("markets")
}

// ============================================
// MARKET LOCATION TYPES - Normalized types
// ============================================

model MarketLocationType {
  id          String   @id @default(cuid())
  code        String   @unique // NATIONAL_AVERAGE, CAPITAL_CITY, RETAIL...
  nameEn      String   @map("name_en")
  nameAz      String?  @map("name_az")
  description String?
  sortOrder   Int      @default(0) @map("sort_order")
  aliases     String? // JSON array of original FPMA values
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fpmaSeries FpmaSerie[]

  @@map("market_location_types")
}

// ============================================
// LOCAL PRODUCT STRUCTURE (AZ)
// ============================================

model Category {
  id               String   @id @default(cuid())
  name             String
  nameEn           String?  @map("name_en")
  nameRu           String?  @map("name_ru")
  slug             String
  aliases          String? // Comma-separated aliases for Excel import mapping
  countryId        String
  globalCategoryId String?  @map("global_category_id") // Link to global category
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  country        Country         @relation(fields: [countryId], references: [id])
  globalCategory GlobalCategory? @relation(fields: [globalCategoryId], references: [id])
  products       Product[]

  @@unique([countryId, slug])
  @@index([globalCategoryId])
  @@map("categories")
}

model Product {
  id              String   @id @default(cuid())
  name            String
  nameEn          String?  @map("name_en")
  nameRu          String?  @map("name_ru")
  slug            String
  unit            String   @default("kg")
  aliases         String? // Comma-separated aliases for Excel import mapping
  categoryId      String
  countryId       String
  globalProductId String?  @map("global_product_id") // Link to global product
  faoCode         String?  @map("fao_code")
  hsCode          String?  @map("hs_code")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  country       Country            @relation(fields: [countryId], references: [id])
  category      Category           @relation(fields: [categoryId], references: [id])
  globalProduct GlobalProduct?     @relation(fields: [globalProductId], references: [id])
  productTypes  ProductType[]
  prices        Price[]
  euProducts    EuProduct[] // Linked EU products for comparison
  aggregates    AzPriceAggregate[]

  @@unique([countryId, slug])
  @@index([countryId])
  @@index([categoryId])
  @@index([globalProductId])
  @@map("products")
}

model ProductType {
  id                     String   @id @default(cuid())
  name                   String
  nameEn                 String?  @map("name_en")
  nameRu                 String?  @map("name_ru")
  aliases                String? // Comma-separated aliases for Excel import mapping
  productId              String
  globalProductVarietyId String?  @map("global_product_variety_id") // Link to global variety
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  product              Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  globalProductVariety GlobalProductVariety? @relation(fields: [globalProductVarietyId], references: [id])
  prices               Price[]
  aggregates           AzPriceAggregate[]

  @@unique([productId, name])
  @@index([globalProductVarietyId])
  @@map("product_types")
}

// ============================================
// PRICE DATA
// ============================================

model Price {
  id            String   @id @default(cuid())
  countryId     String
  productId     String
  productTypeId String?
  marketId      String
  date          DateTime
  priceMin      Float    @map("price_min")
  priceAvg      Float    @map("price_avg")
  priceMax      Float    @map("price_max")
  unit          String   @default("kg")
  currency      String   @default("AZN")
  source        String   @default("agro.gov.az")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  country     Country      @relation(fields: [countryId], references: [id])
  product     Product      @relation(fields: [productId], references: [id])
  productType ProductType? @relation(fields: [productTypeId], references: [id])
  market      Market       @relation(fields: [marketId], references: [id])

  @@unique([countryId, productId, productTypeId, marketId, date])
  @@index([countryId, productId, date])
  @@index([countryId, marketId, date])
  @@index([productId, marketId, date])
  @@index([date])
  @@map("prices")
}

// ============================================
// UNITS OF MEASUREMENT
// ============================================

model Unit {
  id             String   @id @default(cuid())
  code           String   @unique // kg, 100kg, lb, ton, piece
  nameAz         String   @map("name_az")
  nameEn         String   @map("name_en")
  nameRu         String?  @map("name_ru")
  symbol         String? // kg, lb, t
  baseUnit       String   @default("kg") @map("base_unit") // Reference base unit
  conversionRate Float    @default(1) @map("conversion_rate") // Rate to convert to base unit
  category       String   @default("weight") // weight, volume, piece
  fpmaAliases    String?  @map("fpma_aliases") // JSON: ["Kg", "1 kg", "kg"]
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("units")
}

// ============================================
// CURRENCY & FX RATES
// ============================================

model Currency {
  id          String   @id @default(cuid())
  code        String   @unique // AZN, USD, EUR, RUB, TRY
  symbol      String // â‚¼, $, â‚¬, â‚½, â‚º
  nameAz      String   @map("name_az")
  nameEn      String?  @map("name_en")
  nameRu      String?  @map("name_ru")
  rateToAZN   Float    @default(1) @map("rate_to_azn") // Exchange rate to AZN
  isBase      Boolean  @default(false) @map("is_base") // Is this the base currency (AZN)
  isActive    Boolean  @default(true) @map("is_active")
  lastUpdated DateTime @default(now()) @map("last_updated")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("currencies")
}

model FxRateHistory {
  id           String   @id @default(cuid())
  currencyCode String   @map("currency_code")
  rateToAZN    Float    @map("rate_to_azn")
  source       String   @default("freecurrencyapi") // API source
  fetchedAt    DateTime @default(now()) @map("fetched_at")
  createdAt    DateTime @default(now())

  @@index([currencyCode, fetchedAt])
  @@map("fx_rate_history")
}

// ============================================
// DATA UPLOADS (for tracking)
// ============================================

model Upload {
  id           String   @id @default(cuid())
  fileName     String   @map("file_name")
  fileSize     Int      @map("file_size")
  type         String // PRICES, PRODUCTS, MARKETS
  status       String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  recordsTotal Int?     @map("records_total")
  recordsNew   Int?     @map("records_new")
  recordsError Int?     @map("records_error")
  errorMessage String?  @map("error_message")
  uploadedBy   String   @map("uploaded_by")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("uploads")
}

// ============================================
// GLOBAL PRODUCTS - Universal product mapping
// ============================================

model GlobalProduct {
  id     String  @id @default(cuid())
  slug   String  @unique // apple, tomato, potato
  hsCode String? @map("hs_code") // HS6: "070190", "080810"

  // Names
  nameEn String  @map("name_en") // Apple
  nameAz String? @map("name_az") // Alma
  nameRu String? @map("name_ru") // Ð¯Ð±Ð»Ð¾ÐºÐ¾

  // Category link (new)
  globalCategoryId String?         @map("global_category_id")
  globalCategory   GlobalCategory? @relation(fields: [globalCategoryId], references: [id])

  // Legacy category string (deprecated, for migration)
  category String?

  // External codes
  faoCode      String? @map("fao_code") // FAO Item Code (e.g., "515")
  cpcCode      String? @map("cpc_code") // CPC classification code
  eurostatCode String? @map("eurostat_code") // Eurostat code
  fpmaCode     String? @map("fpma_code") // FPMA base commodity code (e.g., "070190")

  defaultUnit String  @default("kg") @map("default_unit")
  image       String?

  // Rich content for product pages (Tridge-style)
  descriptionAz String? @map("description_az")
  descriptionEn String? @map("description_en")
  history       String?
  uses          String?
  nutrition     String?
  varieties     String? // Legacy text field
  storage       String?
  seasonality   String?

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productVarieties GlobalProductVariety[]
  localProducts    Product[]
  euProducts       EuProduct[]
  faoProducts      FaoProduct[]
  fpmaCommodities  FpmaCommodity[]
  azAggregates     GlobalAzAggregate[]

  @@index([globalCategoryId])
  @@index([category])
  @@map("global_products")
}

// ============================================
// GLOBAL PRODUCT VARIETIES
// ============================================

model GlobalProductVariety {
  id              String @id @default(cuid())
  globalProductId String @map("global_product_id")

  slug   String // base, red, white, imported, organic, long-grain
  nameEn String  @map("name_en") // "Red", "White", "Imported", "Long Grain"
  nameAz String? @map("name_az") // "QÄ±rmÄ±zÄ±", "AÄŸ", "Ä°dxal"
  nameRu String? @map("name_ru")
  
  // Additional info
  hsCode      String? @map("hs_code") // HS code for this variety
  description String?
  image       String? // Image URL

  // Source mappings
  fpmaVarietyCode String? @map("fpma_variety_code") // "070190_2", "100630_2"
  
  // Mapping status for admin
  isAutoMatched Boolean @default(false) @map("is_auto_matched") // Auto-matched vs manual
  matchScore    Float?  @map("match_score") // Confidence score for auto-match

  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  globalProduct   GlobalProduct     @relation(fields: [globalProductId], references: [id], onDelete: Cascade)
  productTypes    ProductType[]     // Link to local AZ product types
  fpmaCommodities FpmaCommodity[]   // Link to FPMA commodities

  @@unique([globalProductId, slug])
  @@index([fpmaVarietyCode])
  @@map("global_product_varieties")
}

// ============================================
// EU DATA - European Commission & Eurostat
// ============================================

model EuCountry {
  id              String   @id @default(cuid())
  code            String   @unique // DE, FR, IT, ES, PL...
  nameAz          String?  @map("name_az")
  nameEn          String   @map("name_en")
  nameRu          String?  @map("name_ru")
  region          String?
  globalCountryId String?  @map("global_country_id") // Link to GlobalCountry
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  globalCountry GlobalCountry? @relation(fields: [globalCountryId], references: [id])
  prices        EuPrice[]

  @@index([globalCountryId])
  @@map("eu_countries")
}

model EuProduct {
  id             String  @id @default(cuid())
  eurostatCode   String? @unique @map("eurostat_code")
  ecAgrifoodCode String? @map("ec_agrifood_code")
  nameEn         String  @map("name_en")
  nameAz         String? @map("name_az")
  nameRu         String? @map("name_ru")
  unit           String  @default("â‚¬/100kg")
  category       String?

  globalProductId String?        @map("global_product_id")
  globalProduct   GlobalProduct? @relation(fields: [globalProductId], references: [id], onDelete: SetNull)

  localProductId String?  @map("local_product_id")
  localProduct   Product? @relation(fields: [localProductId], references: [id], onDelete: SetNull)
  matchScore     Float?   @map("match_score")
  isManualMatch  Boolean  @default(false) @map("is_manual_match")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  prices EuPrice[]

  @@index([globalProductId])
  @@index([localProductId])
  @@index([category])
  @@map("eu_products")
}

model EuPrice {
  id           String    @id @default(cuid())
  countryId    String    @map("country_id")
  productId    String    @map("product_id")
  price        Float
  currency     String    @default("EUR")
  unit         String
  source       String
  sourceName   String?   @map("source_name")
  sourceUrl    String?   @map("source_url")
  priceStage   String?   @map("price_stage")
  periodType   String    @map("period_type")
  period       Int?
  year         Int
  startDate    DateTime? @map("start_date")
  endDate      DateTime? @map("end_date")
  variety      String?
  market       String?
  isCalculated Boolean   @default(false) @map("is_calculated")
  fetchedAt    DateTime  @default(now()) @map("fetched_at")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  country EuCountry @relation(fields: [countryId], references: [id], onDelete: Cascade)
  product EuProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([countryId, productId, year, period, periodType, priceStage, variety])
  @@index([countryId])
  @@index([productId])
  @@index([year, period])
  @@index([source])
  @@index([priceStage])
  @@map("eu_prices")
}

// ============================================
// AZ AGGREGATE PRICES - Weekly/Monthly averages
// ============================================

model AzPriceAggregate {
  id            String   @id @default(cuid())
  productId     String   @map("product_id")
  productTypeId String?  @map("product_type_id")
  countryId     String   @map("country_id")
  marketTypeId  String   @map("market_type_id")
  avgPrice      Float    @map("avg_price")
  minPrice      Float    @map("min_price")
  maxPrice      Float    @map("max_price")
  priceCount    Int      @map("price_count")
  periodType    String   @map("period_type")
  period        Int
  year          Int
  startDate     DateTime @map("start_date")
  endDate       DateTime @map("end_date")
  source        String   @default("agro.gov.az")
  sourceName    String   @default("AzÉ™rbaycan KÉ™nd TÉ™sÉ™rrÃ¼fatÄ± Nazirliyi (agro.gov.az)") @map("source_name")
  calculatedAt  DateTime @default(now()) @map("calculated_at")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  product     Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  productType ProductType? @relation(fields: [productTypeId], references: [id], onDelete: SetNull)
  country     Country      @relation(fields: [countryId], references: [id], onDelete: Cascade)
  marketType  MarketType   @relation(fields: [marketTypeId], references: [id], onDelete: Cascade)

  @@unique([productId, productTypeId, marketTypeId, countryId, year, period, periodType])
  @@index([productId])
  @@index([marketTypeId])
  @@index([year, period])
  @@map("az_price_aggregates")
}

// ============================================
// EU DATA SYNC TRACKING
// ============================================

model EuDataSync {
  id             String    @id @default(cuid())
  source         String
  syncType       String    @map("sync_type")
  status         String    @default("PENDING")
  recordsTotal   Int?      @map("records_total")
  recordsNew     Int?      @map("records_new")
  recordsUpdated Int?      @map("records_updated")
  recordsError   Int?      @map("records_error")
  errorMessage   String?   @map("error_message")
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([source])
  @@index([status])
  @@index([createdAt])
  @@map("eu_data_syncs")
}

// ============================================
// FAO DATA - FAOSTAT Global Producer Prices
// ============================================

model FaoCountry {
  id              String   @id @default(cuid())
  code            String   @unique
  m49Code         String?  @map("m49_code")
  iso2            String?
  iso3            String? // Added for FPMA compatibility
  nameEn          String   @map("name_en")
  nameAz          String?  @map("name_az")
  region          String?
  globalCountryId String?  @map("global_country_id") // Link to GlobalCountry
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  globalCountry GlobalCountry? @relation(fields: [globalCountryId], references: [id])
  prices        FaoPrice[]

  @@index([iso2])
  @@index([iso3])
  @@index([globalCountryId])
  @@map("fao_countries")
}

model FaoProduct {
  id              String         @id @default(cuid())
  itemCode        String         @unique @map("item_code")
  cpcCode         String?        @map("cpc_code")
  nameEn          String         @map("name_en")
  nameAz          String?        @map("name_az")
  category        String?
  globalProductId String?        @map("global_product_id")
  globalProduct   GlobalProduct? @relation(fields: [globalProductId], references: [id], onDelete: SetNull)
  isActive        Boolean        @default(true) @map("is_active")
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  prices FaoPrice[]

  @@index([globalProductId])
  @@index([category])
  @@map("fao_products")
}

model FaoPrice {
  id          String   @id @default(cuid())
  countryId   String   @map("country_id")
  productId   String   @map("product_id")
  price       Float
  currency    String
  unit        String   @default("tonne")
  elementCode String   @map("element_code")
  elementName String   @map("element_name")
  year        Int
  periodType  String   @default("ANNUAL") @map("period_type")
  flag        String?
  source      String   @default("FAOSTAT")
  sourceUrl   String?  @map("source_url")
  fetchedAt   DateTime @default(now()) @map("fetched_at")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  country FaoCountry @relation(fields: [countryId], references: [id], onDelete: Cascade)
  product FaoProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([countryId, productId, year, elementCode])
  @@index([countryId])
  @@index([productId])
  @@index([year])
  @@index([elementCode])
  @@map("fao_prices")
}

// ============================================
// GLOBAL AZ AGGREGATE PRICES
// ============================================

model GlobalAzAggregate {
  id              String    @id @default(cuid())
  globalProductId String    @map("global_product_id")
  marketTypeCode  String    @map("market_type_code")
  avgPrice        Float     @map("avg_price")
  minPrice        Float     @map("min_price")
  maxPrice        Float     @map("max_price")
  sampleCount     Int       @map("sample_count")
  currency        String    @default("AZN")
  unit            String    @default("kg")
  periodType      String    @map("period_type")
  period          Int?
  year            Int
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  source          String    @default("agro.gov.az")
  calculatedAt    DateTime  @default(now()) @map("calculated_at")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  globalProduct GlobalProduct @relation(fields: [globalProductId], references: [id], onDelete: Cascade)

  @@unique([globalProductId, marketTypeCode, year, period, periodType])
  @@index([globalProductId])
  @@index([marketTypeCode])
  @@index([year, period])
  @@map("global_az_aggregates")
}

// ============================================
// FAO FPMA DATA - Food Price Monitoring & Analysis
// ============================================

// FPMA Countries
model FpmaCountry {
  id              String   @id @default(cuid())
  iso3            String   @unique // AFG, AZE, DEU
  iso2            String? // AF, AZ, DE
  nameEn          String   @map("name_en")
  nameAz          String?  @map("name_az")
  nameRu          String?  @map("name_ru")
  region          String?
  globalCountryId String?  @map("global_country_id") // Link to GlobalCountry
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  globalCountry GlobalCountry? @relation(fields: [globalCountryId], references: [id])
  markets       FpmaMarket[]
  series        FpmaSerie[]

  @@index([iso2])
  @@index([globalCountryId])
  @@map("fpma_countries")
}

// FPMA Markets
model FpmaMarket {
  id                 String   @id @default(cuid())
  faoId              Int      @unique @map("fao_id")
  name               String
  countryId          String   @map("country_id")
  adminUnit          String?  @map("admin_unit")
  info               String?
  originalMarketType String?  @map("original_market_type")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  country FpmaCountry @relation(fields: [countryId], references: [id])
  series  FpmaSerie[]

  @@index([countryId])
  @@map("fpma_markets")
}

// FPMA Commodities (Stage - original data)
model FpmaCommodity {
  id                     String         @id @default(cuid())
  code                   String         @unique // 070190_1, 080810_1
  baseCode               String         @map("base_code") // 070190, 080810
  nameEn                 String         @map("name_en")
  nameAz                 String?        @map("name_az")
  varietyName            String?        @map("variety_name") // "imported", "red", "white"
  globalProductId        String?        @map("global_product_id")
  globalProductVarietyId String?        @map("global_product_variety_id") // Link to variety
  globalProduct          GlobalProduct? @relation(fields: [globalProductId], references: [id])
  globalProductVariety   GlobalProductVariety? @relation(fields: [globalProductVarietyId], references: [id])
  isActive               Boolean        @default(true) @map("is_active")
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt

  series FpmaSerie[]

  @@index([baseCode])
  @@index([globalProductId])
  @@index([globalProductVarietyId])
  @@map("fpma_commodities")
}

// FPMA Sources
model FpmaSource {
  id        String   @id @default(cuid())
  faoId     Int      @unique @map("fao_id")
  name      String
  url       String?
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  series FpmaSerie[]

  @@map("fpma_sources")
}

// FPMA Data Series
model FpmaSerie {
  id                    String   @id @default(cuid())
  uuid                  String   @unique
  countryId             String   @map("country_id")
  commodityId           String   @map("commodity_id")
  marketId              String   @map("market_id")
  sourceId              String   @map("source_id")
  marketLocationTypeId  String?  @map("market_location_type_id")
  priceType             String   @map("price_type") // RETAIL, WHOLESALE
  currency              String
  measureUnit           String   @map("measure_unit") // Original: "Kg", "100 kg"
  measureUnitNormalized String?  @map("measure_unit_normalized") // kg, liter
  conversionFactor      Float?   @map("conversion_factor")
  startDate             DateTime @map("start_date")
  endDate               DateTime @map("end_date")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  country            FpmaCountry         @relation(fields: [countryId], references: [id])
  commodity          FpmaCommodity       @relation(fields: [commodityId], references: [id])
  market             FpmaMarket          @relation(fields: [marketId], references: [id])
  source             FpmaSource          @relation(fields: [sourceId], references: [id])
  marketLocationType MarketLocationType? @relation(fields: [marketLocationTypeId], references: [id])
  prices             FpmaPrice[]

  @@index([countryId])
  @@index([commodityId])
  @@index([priceType])
  @@index([marketLocationTypeId])
  @@map("fpma_series")
}

// FPMA Prices
model FpmaPrice {
  id              String   @id @default(cuid())
  serieId         String   @map("serie_id")
  price           Float
  priceReal       Float?   @map("price_real")
  priceUsd        Float?   @map("price_usd")
  priceNormalized Float?   @map("price_normalized") // per kg, original currency
  date            DateTime
  periodicity     String // weekly, monthly
  createdAt       DateTime @default(now())

  serie FpmaSerie @relation(fields: [serieId], references: [id], onDelete: Cascade)

  @@unique([serieId, date])
  @@index([date])
  @@map("fpma_prices")
}

// ============================================
// FPMA DATA SYNC TRACKING
// ============================================

model FpmaDataSync {
  id            String    @id @default(cuid())
  syncType      String    @map("sync_type") // FULL, INCREMENTAL
  status        String    @default("PENDING")
  seriesTotal   Int?      @map("series_total")
  seriesNew     Int?      @map("series_new")
  seriesUpdated Int?      @map("series_updated")
  pricesTotal   Int?      @map("prices_total")
  pricesNew     Int?      @map("prices_new")
  errorMessage  String?   @map("error_message")
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("fpma_data_syncs")
}
